<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>戦闘減衰シミュレータ v2.6</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f8; margin: 20px; color: #333; }
    h2 { text-align: center; color: #1a73e8; }
    
    .container { max-width: 1000px; margin: 0 auto; }
    .panels { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    
    fieldset { flex: 1; min-width: 360px; background: #fff; padding: 15px 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    fieldset.A { border-top: 5px solid #1a73e8; }
    fieldset.B { border-top: 5px solid #d93025; }
    
    legend { font-weight: bold; padding: 0 8px; font-size: 1.1em; }
    
    /* 入力エリアを見やすく整理 *2
    .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
    .input-row label { font-size: 0.9em; font-weight: bold; color: #555; }
    .input-row input { width: 80px; padding: 6px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; font-size: 1em; }
    
    /* 計算結果表示エリア */
    .calc-box { background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0; border: 1px solid #eee; }
    .calc-line { display: flex; justify-content: space-between; font-size: 0.95em; margin-bottom: 4px; }
    .res-val { font-weight: bold; color: #d93025; }

    /* 鉄壁エリア */
    .iron-area { margin-top: 10px; text-align: right; }
    .iron-inputs { display: inline-flex; gap: 4px; }
    .iron-inputs input { width: 45px; padding: 4px; text-align: center; }

    /* ボタン */
    .btn-area { text-align: center; margin: 25px 0; }
    #runBtn { 
        padding: 15px 50px; 
        font-size: 1.2em; 
        font-weight: bold; 
        color: white; 
        background: #2f855a; 
        border: none; 
        border-radius: 30px; 
        cursor: pointer; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #runBtn:hover { background: #276749; transform: translateY(-2px); }

    /* グラフ領域（高さをCSSで固定して表示崩れを防ぐ） */
    .chart-wrapper {
        position: relative;
        height: 400px; 
        width: 100%;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 10px;
        box-sizing: border-box;
    }
    
    #result-msg { margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; border-left: 8px solid #555; line-height: 1.6; }
</style>
</head>
<body>

<div class="container">
    <h2>戦闘減衰シミュレータ v7.6</h2>

    <div class="panels">
        <fieldset class="A">
            <legend>自軍（編成A）</legend>
            <div class="input-row"><label>出撃数</label><input id="A_units" type="number" value=""></div>
            
            <div class="input-row"><label>バフ相性火力 (倍)</label><input id="A_buff_f" type="number" value="" step="10"></div>
            <div class="input-row"><label>バフ相性耐久 (倍)</label><input id="A_buff_h" type="number" value="" step="10"></div>
            <div class="input-row"><label>英雄等火力 (倍)</label><input id="A_hero_f" type="number" value="18" step="0.2"></div>
            <div class="input-row"><label>英雄等耐久 (倍)</label><input id="A_hero_h" type="number" value="2.1" step="0.2"></div>
            <div class="input-row"><label>ユニット火力 (倍)</label><input id="A_unit_f" type="number" value="2.89" step="0.2"></div>
            <div class="input-row"><label>ユニット耐久 (倍)</label><input id="A_unit_h" type="number" value="23.1" step="0.2"></div>

            
            <div class="calc-box">
                <div class="calc-line"><span>最終火力倍率:</span><span id="disp_A_f" class="res-val">-</span></div>
                <div class="calc-line"><span>最終耐久倍率:</span><span id="disp_A_h" class="res-val">-</span></div>
            </div>

            <div class="iron-area">
                <small>鉄壁 (R1 / R2 / R3)</small><br>
                <div class="iron-inputs">
                    <input id="A_iron1" type="number" value="48">
                    <input id="A_iron2" type="number" value="48">
                    <input id="A_iron3" type="number" value="0">
                </div>
            </div>
        </fieldset>

        <fieldset class="B">
            <legend>敵軍（編成B）</legend>
            <div class="input-row"><label>出撃数</label><input id="B_units" type="number" value="200"></div>
            
            <div class="input-row"><label>バフ相性火力 (倍)</label><input id="B_buff_f" type="number" value="120" step="10"></div>
            <div class="input-row"><label>バフ相性耐久 (倍)</label><input id="B_buff_h" type="number" value="240" step="10"></div>
            <div class="input-row"><label>英雄等火力 (倍)</label><input id="B_hero_f" type="number" value="18" step="0.2"></div>
            <div class="input-row"><label>英雄等耐久 (倍)</label><input id="B_hero_h" type="number" value="2.1" step="0.2"></div>
            <div class="input-row"><label>ユニット火力 (倍)</label><input id="B_unit_f" type="number" value="2.89" step="0.2"></div>
            <div class="input-row"><label>ユニット耐久 (倍)</label><input id="B_unit_h" type="number" value="23.1" step="0.2"></div>

            <div class="calc-box">
                <div class="calc-line"><span>最終火力倍率:</span><span id="disp_B_f" class="res-val">-</span></div>
                <div class="calc-line"><span>最終耐久倍率:</span><span id="disp_B_h" class="res-val">-</span></div>
            </div>

            <div class="iron-area">
                <small>鉄壁 (R1 / R2 / R3)</small><br>
                <div class="iron-inputs">
                    <input id="B_iron1" type="number" value="48">
                    <input id="B_iron2" type="number" value="48">
                    <input id="B_iron3" type="number" value="0">
                </div>
            </div>
        </fieldset>
    </div>

    <div class="btn-area">
        <button id="runBtn">シミュレーション実行</button>
    </div>

    <div class="chart-wrapper">
        <canvas id="myChart"></canvas>
    </div>
    <div id="result-msg"></div>
</div>

<script>
// --- グローバル変数 ---
let myChart = null;

// --- ユーティリティ: 安全な数値取得 ---
// IDが見つからない、または空欄の場合に 0 または 1 (multiply用) を返す
function getVal(id, defaultVal = 0) {
    const el = document.getElementById(id);
    if (!el) {
        console.error("IDが見つかりません:", id);
        return defaultVal;
    }
    const val = parseFloat(el.value);
    return isNaN(val) ? defaultVal : val;
}

// --- メイン処理: シミュレーション実行 ---
function runSimulation() {
    try {
        // 1. 入力値の取得と最終倍率計算
        // ゼロ除算や無効値を防ぐため、未入力時は 1 (倍率計算のため) をデフォルトにする
        const A_f = getVal("A_buff_f", 1) * getVal("A_hero_f", 1) * getVal("A_unit_f", 1);
        const A_h = getVal("A_buff_h", 1) * getVal("A_hero_h", 1) * getVal("A_unit_h", 1);
        
        const B_f = getVal("B_buff_f", 1) * getVal("B_hero_f", 1) * getVal("B_unit_f", 1);
        const B_h = getVal("B_buff_h", 1) * getVal("B_hero_h", 1) * getVal("B_unit_h", 1);

        // 表示更新
        document.getElementById("disp_A_f").innerText = A_f.toFixed(2);
        document.getElementById("disp_A_h").innerText = A_h.toFixed(2);
        document.getElementById("disp_B_f").innerText = B_f.toFixed(2);
        document.getElementById("disp_B_h").innerText = B_h.toFixed(2);

        // 2. シミュレーション初期設定
        let HA = getVal("A_units", 200);
        let HB = getVal("B_units", 200);
        const HA0 = HA;
        const HB0 = HB;

        // ランチェスター係数 (防御側耐久が0だと無限大になるので保護)
        const safeAh = A_h > 0 ? A_h : 1;
        const safeBh = B_h > 0 ? B_h : 1;
        
        const alphaBase = A_f / safeBh; // 自軍の攻撃力係数
        const betaBase  = B_f / safeAh; // 敵軍の攻撃力係数

        // 鉄壁データ
        const A_iron = [getVal("A_iron1"), getVal("A_iron2"), getVal("A_iron3")];
        const B_iron = [getVal("B_iron1"), getVal("B_iron2"), getVal("B_iron3")];

        // ループ準備
        let t = 0;
        const dt = 0.05; // 時間刻み
        
        const labels = [];
        const dataA = [];
        const dataB = [];

        // 初期値記録
        labels.push("0.0");
        dataA.push(HA);
        dataB.push(HB);

        // 3. ループ計算 (最大35ラウンド)
        while (t < 35) {
            // どちらかが全滅したら終了
            if (HA <= 0 || HB <= 0) break;

            const round = Math.floor(t) + 1;
            
            // 鉄壁軽減率 (3ラウンド目まで有効)
            const ironA_val = round <= 3 ? A_iron[round-1] : 0;
            const ironB_val = round <= 3 ? B_iron[round-1] : 0;

            // 実効攻撃係数
            const alpha = alphaBase * (1 - ironB_val / 100);
            const beta  = betaBase  * (1 - ironA_val / 100);

            // 減少量
            const dHA = -beta * HB * dt;
            const dHB = -alpha * HA * dt;

            HA += dHA;
            HB += dHB;
            t += dt;

            
                labels.push(t.toFixed(1));
                dataA.push(HA > 0 ? HA : 0);
                dataB.push(HB > 0 ? HB : 0);
            
        }

        // 4. グラフ描画 (既存チャートがあれば破棄して再生成)
        const ctx = document.getElementById('myChart');
        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '自軍 (A)',
                        data: dataA,
                        borderColor: '#2b6cb0',
                        backgroundColor: 'rgba(43, 108, 176, 0.1)',
                        borderWidth: 3,
                        pointRadius: 0, 
                        fill: true,
                        tension: 0.1 // 少し曲線を滑らかに
                    },
                    {
                        label: '敵軍 (B)',
                        data: dataB,
                        borderColor: '#c53030',
                        backgroundColor: 'rgba(197, 48, 48, 0.1)',
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // 親要素の高さに合わせる
                animation: { duration: 0 }, // 高速化のためアニメーションなし
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { title: { display: true, text: 'ラウンド' } },
                    y: { title: { display: true, text: '残り台数' }, min: 0 }
                }
            }
        });

        // 5. 結果テキスト作成
        const finalA = Math.max(0, Math.ceil(HA));
        const finalB = Math.max(0, Math.ceil(HB));
        
        let msg = "";
        if (finalA > finalB) msg = `<b style="color:#2b6cb0; font-size:1.3em;">判定: 自軍(A)の勝利</b>`;
        else if (finalB > finalA) msg = `<b style="color:#c53030; font-size:1.3em;">判定: 敵軍(B)の勝利</b>`;
        else msg = `<b>判定: 引き分け</b>`;

        msg += `<br>戦闘終了: ${t.toFixed(1)} ラウンド<br>`;
        msg += `自軍残り: ${finalA}台 (${(finalA/HA0*100).toFixed(1)}%)<br>`;
        msg += `敵軍残り: ${finalB}台 (${(finalB/HB0*100).toFixed(1)}%)`;

        document.getElementById("result-msg").innerHTML = msg;

    } catch (e) {
        console.error(e);
        alert("エラーが発生しました: " + e.message);
    }
}

// ページ読み込み完了後にイベントを設定
window.addEventListener('load', function() {
    // --- セッションストレージからデータを復元 ---
    const keys = ['A_units', 'A_buff_f', 'A_buff_h', 'B_units', 'B_buff_f', 'B_buff_h'];
    
    keys.forEach(key => {
        const savedValue = sessionStorage.getItem(key);
        const element = document.getElementById(key);
        if (savedValue !== null && element) {
            // 保存された値が有効な数値であればセット（小数点2桁に整形）
            const val = parseFloat(savedValue);
            element.value = isNaN(val) ? "" : val.toFixed(2);
        }
    });

    // 鉄壁の同期設定
    document.getElementById("A_iron1").addEventListener("input", function() {
        document.getElementById("A_iron2").value = this.value;
    });
    document.getElementById("B_iron1").addEventListener("input", function() {
        document.getElementById("B_iron2").value = this.value;
    });

    // ボタンにイベント設定
    document.getElementById("runBtn").addEventListener("click", runSimulation);

    // ストレージにデータがあれば自動実行
    if (sessionStorage.getItem('A_units')) {
        runSimulation();
    }
});
</script>

</body>
</html>